#include <pthread.h>
#include "computation_threads.h"

//=============================================================
// Local declarations added to this autogenerated file to
// support the separate computation threads running on
// this server.
//=============================================================

// Create pointers to data storage
float local_cpu_loading[4];
float *cpu_loading = local_cpu_loading;

float local_memory_loading[4];
float *memory_loading = local_memory_loading;

float local_active_processes[4];
float *active_processes = local_active_processes;

// Create pointers to data locks
pthread_mutex_t cpu_lock;
pthread_mutex_t memory_lock;
pthread_mutex_t processes_lock;

pthread_mutex_t *cpu_lock_ptr = &cpu_lock;
pthread_mutex_t *memory_lock_ptr = &memory_lock;
pthread_mutex_t *processes_lock_ptr = &processes_lock;
//=============================================================

    //===================================================================================================
	// Code has been added to this autogenerated file to support computation threads running
	// in the background on this server. This allows the server to collect usage data over time
	// and to calculate it on a periodic schedule.
	//===================================================================================================

	// Initialize locks
	pthread_mutex_init(cpu_lock_ptr, NULL);
	pthread_mutex_init(memory_lock_ptr, NULL);
	pthread_mutex_init(processes_lock_ptr, NULL);

	// Allocate memory for parameters passed through computation threads
	struct thread_args *cpu_args = (struct thread_args *)malloc(sizeof(struct thread_args));
	struct thread_args *memory_args = (struct thread_args *)malloc(sizeof(struct thread_args));
	struct thread_args *processes_args = (struct thread_args *)malloc(sizeof(struct thread_args));

	cpu_args->data_ptr = cpu_loading;
	cpu_args->lock = cpu_lock_ptr;

	memory_args->data_ptr = memory_loading;
	memory_args->lock = memory_lock_ptr;

	processes_args->data_ptr = active_processes;
	processes_args->lock = processes_lock_ptr;

	pthread_t cpu_thread;
	pthread_t memory_thread;
	pthread_t processes_thread;

	// Start computation threads
	pthread_create(&cpu_thread, NULL, cpu_computation, (void *)cpu_args);
	pthread_create(&memory_thread, NULL, memory_computation, (void *)memory_args);
	pthread_create(&processes_thread, NULL, processes_computation, (void *)processes_args);

	//===================================================================================================