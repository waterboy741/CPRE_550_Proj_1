cmake_minimum_required(VERSION 3.31)
project(RPC_Project C CXX)

# Needed for rpcgen -k generation option
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_C_STANDARD 17)

find_library(RPC_LIBRARY
    NAMES tirpc
    PATHS /usr/include/tirpc
)

find_path(RPC_INCLUDE_DIR
    NAMES rpc/rpc.h
    PATHS /usr/include/tirpc
)

find_program(RPCGEN_EXEC "rpcgen" REQUIRED)

set(SOURCE_DIR "../src/")
set(INCLUDE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/include/")

# Main files for two programs
set(CLIENT_FILE "${SOURCE_DIR}/client.c")
set(SERVER_FILE "${SOURCE_DIR}/server.c")
set(THREAD_FILE "${SOURCE_DIR}/computation_threads.c")

# Define variables for rpcgen files
set(RPC_X_FILE "${INCLUDE_DIR}/rpc_service.x")
set(RPC_GEN_CLIENT_C "${INCLUDE_DIR}/rpc_service_clnt.c")
set(RPC_GEN_SERVER_C "${INCLUDE_DIR}/rpc_service_svc.c")
set(RPC_GEN_HEADER_H "${INCLUDE_DIR}/rpc_service.h")

# Only uncomment this if you know how to apply patches on top of autogenerated code
# # Custom command to run rpcgen when needed
# add_custom_command(
#     OUTPUT ${RPC_GEN_CLIENT_C} ${RPC_GEN_SERVER_C} ${RPC_GEN_HEADER_H}
#     COMMAND ${RPCGEN_EXEC} -k ${RPC_X_FILE} 
#     DEPENDS ${RPC_X_FILE}
#     WORKING_DIRECTORY ${INCLUDE_DIR}
#     COMMENT "Generating Date RPC source files with rpcgen"
# )

#Client executable
add_executable(client 
    ${CLIENT_FILE}
    ${RPC_GEN_CLIENT_C})
    target_include_directories(client PRIVATE ${RPC_INCLUDE_DIR})
    target_include_directories(client PRIVATE ${INCLUDE_DIR})
    target_link_libraries(client PRIVATE ${RPC_LIBRARY})

#Server executable with extra threading utils
add_executable(server 
    ${SERVER_FILE}
    ${THREAD_FILE}
    ${RPC_GEN_SERVER_C})
    target_include_directories(server PRIVATE ${RPC_INCLUDE_DIR})
    target_include_directories(server PRIVATE ${INCLUDE_DIR})
    target_link_libraries(server PRIVATE ${RPC_LIBRARY})